name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login != 'dependabot[bot]'
    steps:
      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            PR title subject must start with an uppercase letter.
            Example: "feat: Add new encoder support"

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            let size, color;
            if (totalChanges > 1000) {
              size = 'XL';
              color = 'ðŸ”´';
            } else if (totalChanges > 500) {
              size = 'L';
              color = 'ðŸŸ ';
            } else if (totalChanges > 200) {
              size = 'M';
              color = 'ðŸŸ¡';
            } else {
              size = 'S';
              color = 'ðŸŸ¢';
            }

            await core.summary
              .addHeading('PR Size Analysis')
              .addTable([
                [{data: 'Metric', header: true}, {data: 'Value', header: true}],
                ['Additions', `+${additions}`],
                ['Deletions', `-${deletions}`],
                ['Total Changes', `${totalChanges}`],
                ['Size', `${color} ${size}`]
              ])
              .write();

            if (totalChanges > 1000) {
              core.warning(`Large PR detected (${totalChanges} lines). Consider breaking into smaller PRs.`);
            }
