name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "nuitka>=2.8.9" "ordered-set>=4.1.0" "zstandard>=0.25.0"
          pip install "pyyaml>=6.0.3" "rich>=14.2.0" "pymediainfo>=7.0.1"

      - name: Extract version info
        id: version
        shell: python
        run: |
          import os
          import re
          import sys
          sys.path.insert(0, "src")
          from videotuner.version import __version__, RELEASE_NOTES

          # Write to GitHub outputs
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"version={__version__}\n")

          # Extract only the current version's release notes
          # Matches from "## X.X.X" until the next "## " or end of string
          pattern = rf"## {re.escape(__version__)}.*?(?=\n## |\Z)"
          match = re.search(pattern, RELEASE_NOTES, re.DOTALL)

          if match:
              current_notes = match.group(0).strip()
          else:
              current_notes = f"Release {__version__}"

          with open("release_notes.md", "w", encoding="utf-8") as f:
              f.write(current_notes)

      - name: Verify tag matches version
        shell: bash
        run: |
          TAG_VERSION="${{ github.ref_name }}"
          CODE_VERSION="v${{ steps.version.outputs.version }}"
          if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
            echo "::error::Tag ($TAG_VERSION) does not match code version ($CODE_VERSION)"
            exit 1
          fi

      - name: Build release
        run: python build.py

      - name: Create release zip
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $releaseName = "VideoTuner-v$version"
          Compress-Archive -Path "dist/$releaseName/*" -DestinationPath "dist/$releaseName.zip"

      - name: Create GitHub Release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" `
            --title "VideoTuner v${{ steps.version.outputs.version }}" `
            --notes-file release_notes.md `
            "dist/VideoTuner-v${{ steps.version.outputs.version }}.zip"